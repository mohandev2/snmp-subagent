<!-- ...................................................................... -->
<!-- $Id$ ................................................ -->
<!-- 
        This material may be distributed only subject to the terms and 
        conditions set forth in the Open Publication License, v1.0 or later 
        (the latest version is currently available at 
        http://www.opencontent.org/openpub/).  Distribution of substantively 
        modified version of this document is prohibited without the explicit 
        permission of the copyright holder.

        Other company, product, or service names may be trademarks or service 
        marks of others.
-->
<chapter>
    <title>Understanding the sub-agent</title>
  <sect1>
    <title>Attack vector</title>
    <para>
      There are two ways of explaining the details of the generated
      sub-agent code. The first is to explain in detail every piece of the code
      and let the reader make the connection. The other (which we will use) is
      to comb through the code explaining what it does and provide 
      working examples and explanation.
    </para>
    
    <sect2>
      <title>The bare minimum</title>
      
      <para>
	To have just a working, compilable, running code that does not do anything interesting,
	you need two extra files that are not generated by mib2c. They are
	the makefile and the sub-agent startup code.
       </para>

     <sect3>
      <title>Makefile</title>

	<para>Makefile. A good template is available from
	 <ulink url="http://www.net-snmp.org/tutorial-5/toolkit/demoapp/Makefile">NET-SNMP Tutorial</ulink>. 
	</para>

	<programlisting role="C">
OBJS2=example-demon.o netSnmpIETFWGTable.o
TARGETS=example-demon

CFLAGS=-I. `net-snmp-config --cflags`
BUILDLIBS=`net-snmp-config --libs`
BUILDAGENTLIBS=`net-snmp-config --agent-libs`

# shared library flags (assumes gcc)
DLFLAGS=-fPIC -shared

all: $(TARGETS)

example-demon: $(OBJS2)
	$(CC) -o example-demon $(OBJS2)  $(BUILDAGENTLIBS)
netSnmpIETFWGTable.o: netSnmpIETFWGTable.c Makefile
	$(CC) $(CFLAGS) $(DLFLAGS) -c -o netSnmpIETFWGTable.o netSnmpIETFWGTable.c
	$(CC) $(CFLAGS) $(DLFLAGS) -o netSnmpIETFWGTable.so netSnmpIETFWGTable.o
	      </programlisting>
	  </sect3>


	  <sect3>
	   <title>Sub-agent daemon code</title>

	    <para>
	    The daemon will use the generated sub-agent code. 
	    This example daemon code has been taken from 
	      <ulink url="http://www.net-snmp.org/tutorial-5/toolkit/demon/example-demon.c">NET-SNMP Tutorial</ulink> 
	    </para>
	      <programlisting role="C">
     1	#include &lt;net-snmp/net-snmp-config.h&gt;
    2	#include &lt;net-snmp/net-snmp-includes.h&gt;
    3	#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;
    4	#include &lt;signal.h&gt;
    5	
    6	#include &lt;netSnmpIETFWGTable.h>
    7	
    8	static int keep_running;
    9	
   10	RETSIGTYPE
   11	stop_server(int a) {
   12	    keep_running = 0;
   13	}
   14	
   15	int
   16	main (int argc, char **argv) {
   17	  int agentx_subagent=1; /* change this if you want to be a SNMP master agent */
   18	
   19	  /* print log errors to stderr */
   20	  snmp_enable_stderrlog();
   21	
   22	  /* we're an agentx subagent? */
   23	  if (agentx_subagent) {
   24	    /* make us a agentx client. */
   25	    netsnmp_ds_set_boolean(NETSNMP_DS_APPLICATION_ID, NETSNMP_DS_AGENT_ROLE, 1);
   26	  }
   27	
   28	  /* initialize the agent library */
   29	  init_agent("example-demon");
   30	
   31	  /* initialize mib code here */
   32	
   33	  /* mib code: nit_netSnmpIETFWGTable from netSnmpIETFWGTable.c */
   34	  init_netSnmpIETFWGTable();  
   35	
   36	  /* example-demon will be used to read example-demon.conf files. */
   37	  init_snmp("example-demon");
   38	
   39	  /* If we're going to be a snmp master agent, initial the ports */
   40	  if (!agentx_subagent)
   41	    init_master_agent();  /* open the port to listen on (defaults to udp:161) */
   42	
   43	  /* In case we recevie a request to stop (kill -TERM or kill -INT) */
   44	  keep_running = 1;
   45	  signal(SIGTERM, stop_server);
   46	  signal(SIGINT, stop_server);
   47	
   48	  /* you're main loop here... */
   49	  while(keep_running) {
   50	    /* if you use select(), see snmp_select_info() in snmp_api(3) */
   51	    /*     --- OR ---  */
   52	    agent_check_and_process(1); /* 0 == don't block */
   53	  }
   54	
   55	  /* at shutdown time */
   56	  snmp_shutdown("example-demon");
   57	}
	      </programlisting>
	    <note>
	      <para>
		The only change from the original source file code was
		replacing <emphasis>init_nstAgentSubagentObject(); </emphasis> with <emphasis>init_netSnmpIETFWGTable();</emphasis>.
	      </para>
	    </note>
	<para>
	  For right now we will skip explanation of these two files and 
	  concentrate on the sub-agent generated code.
	</para>
       </sect3>
    </sect2>
  </sect1>	
</chapter>
